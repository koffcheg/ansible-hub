#!/usr/bin/env bash
# install.sh — auto-install OpenVPN client files and start service
set -euo pipefail

CONFIG_NAME="{{ client_name }}"
SRC_DIR="$(cd "$(dirname "$0")" && pwd)"
TARGET_DIR="/etc/openvpn/client"
SERVICE="openvpn-client@${CONFIG_NAME}.service"

log() { echo "[install:$CONFIG_NAME] $*"; }

trap 'log "FAILED"; exit 1' ERR

log "Checking OpenVPN package…"
if ! command -v openvpn >/dev/null 2>&1; then
  log "OpenVPN not found, installing"
  sudo apt-get update -qq
  sudo apt-get install -y openvpn
fi

log "Copying config to $TARGET_DIR"
sudo mkdir -p "$TARGET_DIR"
sudo cp "$SRC_DIR"/*.crt  "$TARGET_DIR/"
sudo cp "$SRC_DIR"/*.key  "$TARGET_DIR/"
sudo cp "$SRC_DIR"/ta.key "$TARGET_DIR/"
sudo cp "$SRC_DIR"/ca.crt "$TARGET_DIR/"
sudo cp "$SRC_DIR"/"${CONFIG_NAME}.conf" "$TARGET_DIR/${CONFIG_NAME}.conf"

# lock down private key
sudo chmod 600 "$TARGET_DIR/${CONFIG_NAME}.key"

# optional DNS hooks
if [[ -f "$SRC_DIR/dns-hooks.sh" ]]; then
  sudo cp "$SRC_DIR/dns-hooks.sh" "$TARGET_DIR/"
  sudo chmod 755 "$TARGET_DIR/dns-hooks.sh"
fi

log "Reloading systemd units"
sudo systemctl daemon-reload

log "Enabling and (re)starting $SERVICE"
sudo systemctl enable "$SERVICE"
sudo systemctl restart "$SERVICE"

log "Cleaning up installer files"
cd /
sudo rm -rf "$SRC_DIR"

log "VPN setup complete!"
