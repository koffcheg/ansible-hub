---
# playbooks/factory_pull.yaml
- name: Factory pull of VPN config
  hosts: localhost
  gather_facts: false

  vars:
    output_dir: "{{ lookup('env', 'HOME') }}/factory_output/{{ client_name }}"

  pre_tasks:
    - name: Ensure client_name is provided
      fail:
        msg: "client_name must be passed with -e client_name=NAME"
      when: client_name is not defined or client_name | length == 0

    - name: Load all group vars for delegated localhost
      include_vars: ../group_vars/all.yaml
      delegate_to: localhost
      run_once: true

  tasks:
    - name: Download and extract client config from GCP Secret Manager
      include_role:
        name: vpn_client
        tasks_from: download

    - name: Copy extracted config to factory output directory
      copy:
        src: "{{ factory_client_config_dir }}/{{ client_name }}/"
        dest: "{{ output_dir }}/"
        mode: '0644'
        remote_src: yes

    - name: Render install.sh into factory config dir
      template:
        src: "../../roles/vpn_client/templates/install.sh.j2"
        dest: "{{ output_dir }}/install.sh"
        mode: '0755'

    - name: Confirm USB-ready config folder created
      debug:
        msg: "VPN config + installer ready at {{ output_dir }}"
