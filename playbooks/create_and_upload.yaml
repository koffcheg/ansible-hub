---
# playbooks/create_and_upload.yaml
- name: Create and upload one or multiple VPN clients
  hosts: vpn
  gather_facts: false

  pre_tasks:
    - name: Ensure client_names are provided
      assert:
        that:
          - client_names is defined
          - client_names | length > 0
        fail_msg: "Provide client names via -e 'client_names=[\"client1\"]'"

    - import_tasks: ../tasks/load_controller_vars.yaml

    - name: Parse static_map if it's a JSON string
      set_fact:
        static_map: "{{ static_map | from_json }}"
      when: static_map is defined and static_map is string and static_map | regex_search('^{.*}$')

  tasks:
    - name: Process each client
      block:
        - name: Set client_static_ip from static_map
          set_fact:
            client_static_ip: "{{ static_map[client_name] }}"
          when:
            - static_map is defined
            - client_name in static_map

        - name: Include client onboarding tasks
          include_tasks: tasks/client_flow.yaml

      loop: "{{ client_names }}"
      loop_control:
        loop_var: client_name
