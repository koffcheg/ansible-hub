- name: Generate client certificate
  command: ./easyrsa build-client-full {{ client_name }} nopass
  args:
    chdir: /etc/openvpn/easy-rsa

- name: Fetch generated certs and keys
  fetch:
    src: "/etc/openvpn/easy-rsa/pki/{{ item }}"
    dest: "client-configs/{{ client_name }}/{{ item }}"
    flat: yes
  loop:
    - issued/{{ client_name }}.crt
    - private/{{ client_name }}.key
    - ca.crt
    - ta.key

- name: Create OVPN config
  template:
    src: templates/base_client.conf.j2
    dest: "client-configs/{{ client_name }}/{{ client_name }}.ovpn"

- name: Create client bundle archive
  archive:
    path:
      - "client-configs/{{ client_name }}/ca.crt"
      - "client-configs/{{ client_name }}/client.crt"
      - "client-configs/{{ client_name }}/client.key"
      - "client-configs/{{ client_name }}/ta.key"
      - "client-configs/{{ client_name }}/{{ client_name }}.ovpn"
    dest: "client-configs/{{ client_name }}/{{ client_name }}.tar.gz"
    format: gz
