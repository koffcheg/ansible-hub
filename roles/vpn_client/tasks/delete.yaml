---
# roles/vpn_client/tasks/delete.yaml
# Delete + revoke a VPN client without disturbing others.

- name: Activate GCP service account
  import_tasks: "{{ playbook_dir }}/../tasks/activate_gcp_account.yaml"
  delegate_to: localhost
  run_once: true

- name: Delete GCP Secret (if exists)
  delegate_to: localhost
  shell: |
    if gcloud secrets describe {{ gcp_secrets_prefix }}{{ client_name }} \
         --project={{ gcp_project_id }} 2>/dev/null; then
      gcloud secrets delete {{ gcp_secrets_prefix }}{{ client_name }} \
        --quiet --project={{ gcp_project_id }}
      echo "Deleted secret"
    else
      echo "Secret not found"
    fi
  args:
    executable: /bin/bash
  register: gcp_secret_out
  changed_when: "'Deleted secret' in gcp_secret_out.stdout"

- name: Delete local client config dir on controller
  delegate_to: localhost
  file:
    path: "{{ client_configs_base_dir }}/{{ client_name }}"
    state: absent
  register: local_cleanup

- name: Confirm local cleanup
  debug:
    msg: "Deleted local files at {{ client_configs_base_dir }}/{{ client_name }}"
  when: local_cleanup.changed

- name: Revoke certificate in EasyRSA
  command: ./easyrsa --batch revoke {{ client_name }}
  args:
    chdir: "{{ easy_rsa_dir }}"

- name: Generate updated CRL
  command: ./easyrsa gen-crl
  args:
    chdir: "{{ easy_rsa_dir }}"

- name: Copy refreshed crl.pem to OpenVPN dir
  copy:
    src: "{{ easy_rsa_dir }}/pki/crl.pem"
    dest: "/etc/openvpn/crl.pem"
    owner: root
    group: root
    mode: '0644'
    remote_src: true
    
- name: Delete client cert from EasyRSA
  file:
    path: "{{ easy_rsa_dir }}/pki/issued/{{ client_name }}.crt"
    state: absent

- name: Delete client key from EasyRSA
  file:
    path: "{{ easy_rsa_dir }}/pki/private/{{ client_name }}.key"
    state: absent

- name: Delete client request file
  file:
    path: "{{ easy_rsa_dir }}/pki/reqs/{{ client_name }}.req"
    state: absent

- name: Delete CCD static IP assignment
  file:
    path: "/etc/openvpn/ccd/{{ client_name }}"
    state: absent