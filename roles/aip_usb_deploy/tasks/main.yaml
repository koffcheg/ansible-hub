---
- name: Validate kit_dir
  ansible.builtin.fail:
    msg: "You must pass -e 'aip_kit_dir=<folder>' pointing to /home/checkout/eject_kits/<folder>"
  when: aip_kit_dir == ""

- name: Resolve full kit directory
  ansible.builtin.set_fact:
    kit_path: "{{ aip_eject_kits_root }}/{{ aip_kit_dir }}"

- name: Ensure kit directory exists
  ansible.builtin.stat:
    path: "{{ kit_path }}"
  register: kit_stat

- name: Fail if kit directory missing
  ansible.builtin.fail:
    msg: "Kit directory '{{ kit_path }}' not found."
  when: not kit_stat.stat.exists

# ---------------------------------------------------
# FIND THE .tar.zst ARCHIVE
# ---------------------------------------------------
- name: Find the kit archive
  ansible.builtin.find:
    paths: "{{ kit_path }}"
    patterns: "*.tar.zst"
    file_type: file
  register: kit_archives

- name: Fail if no archive found
  ansible.builtin.fail:
    msg: "No .tar.zst archive found in {{ kit_path }}"
  when: kit_archives.files | length == 0

- name: Select archive
  ansible.builtin.set_fact:
    kit_archive: "{{ kit_archives.files[0].path }}"

# Derive deployment version & deploy_dir
- name: Derive versioned deploy directory
  ansible.builtin.set_fact:
    kit_basename: "{{ kit_archive | basename | regex_replace('\\.tar\\.zst$', '') }}"
    deploy_dir: "{{ aip_deploy_root }}/{{ kit_basename }}"

# ---------------------------------------------------
# EXTRACT KIT
# ---------------------------------------------------
- name: Ensure deploy root exists
  ansible.builtin.file:
    path: "{{ aip_deploy_root }}"
    state: directory
    owner: "{{ aip_deploy_user }}"
    group: "{{ aip_deploy_user }}"
    mode: "0755"

- name: Create deploy_dir
  ansible.builtin.file:
    path: "{{ deploy_dir }}"
    state: directory
    owner: "{{ aip_deploy_user }}"
    group: "{{ aip_deploy_user }}"
    mode: "0755"

- name: Extract kit archive
  become_user: "{{ aip_deploy_user }}"
  ansible.builtin.shell: >
    tar -I zstd -xf "{{ kit_archive }}" -C "{{ deploy_dir }}" --strip-components=1
  args:
    executable: /bin/bash

# ---------------------------------------------------
# RUN INSTALLER
# ---------------------------------------------------
- name: Run installer main.sh
  become_user: "{{ aip_deploy_user }}"
  ansible.builtin.shell: >
    ./main.sh --auto "{{ deploy_dir }}"
  args:
    chdir: "{{ deploy_dir }}/jetson_installer"
    executable: /bin/bash

# ---------------------------------------------------
# UPDATE SYMLINK
# ---------------------------------------------------
- name: Point 'current' symlink to new version
  ansible.builtin.file:
    src: "{{ deploy_dir }}"
    dest: "{{ aip_deploy_root }}/current"
    state: link
    force: true

# ---------------------------------------------------
# RECEIPT
# ---------------------------------------------------
- name: Write receipt
  ansible.builtin.copy:
    dest: "{{ aip_deploy_root }}/current/deploy.receipt"
    owner: "{{ aip_deploy_user }}"
    group: "{{ aip_deploy_user }}"
    mode: "0644"
    content: |
      deploy_dir={{ deploy_dir }}
      archive={{ kit_archive }}
      deployed_at={{ ansible_date_time.iso8601 }}
      host={{ inventory_hostname }}
