---
# Main orchestration tasks for AIP content sync.
# This role:
#   - Locates and downloads the manifest from GCS.
#   - Parses metadata, source/dest info, and rules.
#   - Builds a GCS -> controller overlay (base + overrides).
#   - Stages content on the Jetson under the state dir.
#   - Promotes staged content into final dest_root.
#   - Manages receipts, backups, and optional pruning / healthcheck.

- name: "AIP content sync | Start"
  debug:
    msg: >
      Starting AIP content sync for bundle_id='{{ bundle_id }}'
      and target_version='{{ target_version }}'.

# ---------------------------------------------------------------------------
# 0. Utilities / facts
# ---------------------------------------------------------------------------

- name: Ensure timestamp fact exists even when gather_facts is false
  set_fact:
    aip_cs_timestamp: >-
      {{
        ansible_date_time.iso8601_basic
        if (ansible_date_time is defined)
        else lookup('pipe', 'date +%Y%m%dT%H%M%S')
      }}

# ---------------------------------------------------------------------------
# 1. Prepare state dirs and per-run paths on the Jetson
# ---------------------------------------------------------------------------

- name: Ensure AIP base state directories exist
  become: true
  file:
    path: "{{ item }}"
    state: directory
    owner: "{{ aip_deploy_user }}"
    group: "{{ aip_deploy_user }}"
    mode: "0755"
  loop:
    - "{{ aip_state_dir }}"
    - "{{ stage_root }}"
    - "{{ backups_root }}"
    - "{{ receipts_root }}"

- name: Compute bundle_id hash-safe name
  set_fact:
    bundle_safe_id: "{{ bundle_id | regex_replace('[^a-zA-Z0-9_.-]', '_') }}"

- name: Compute target version string
  set_fact:
    bundle_version: "{{ target_version | default('current') }}"

- name: Compute managed index file name
  set_fact:
    managed_index_name: ".aip-managed-{{ bundle_safe_id }}.json"

- name: Compute stage_dir for this run
  set_fact:
    aip_cs_stage_dir: "{{ stage_root }}/{{ bundle_safe_id }}@{{ bundle_version }}"

- name: Compute backup_dir (timestamped) for this run
  set_fact:
    aip_cs_backup_dir: "{{ backups_root }}/{{ bundle_safe_id }}@{{ bundle_version }}-{{ aip_cs_timestamp }}"

- name: Compute managed index path for receipts
  set_fact:
    aip_cs_managed_index_path: "{{ receipts_root }}/{{ managed_index_name }}"

# ---------------------------------------------------------------------------
# 2. Discover and download manifest from GCS
# ---------------------------------------------------------------------------

- name: Ensure controller work dir root is set
  set_fact:
    aip_cs_work_dir: "{{ aip_cs_work_dir | default(aip_cs_controller_tmp_root) }}"

- name: Initialise manifest_url fact
  set_fact:
    aip_cs_manifest_url: "{{ aip_cs_manifest_url | default('') }}"

# 2.1. Highest priority: explicit bundle_manifest_url
- name: Use explicit bundle_manifest_url if provided
  when:
    - aip_cs_manifest_url | length == 0
    - bundle_manifest_url | default('') | length > 0
  set_fact:
    aip_cs_manifest_url: "{{ bundle_manifest_url }}"

# 2.2. Next: derive manifest_url from bundle_root_url (folder containing manifest.yml)
- name: Probe manifest.yml under bundle_root_url (if provided)
  when:
    - aip_cs_manifest_url | length == 0
    - bundle_root_url | default('') | length > 0
  delegate_to: "{{ aip_cs_controller_host | default('localhost') }}"
  environment:
    CLOUDSDK_CORE_PROJECT: "{{ aip_cs_gcp_project }}"
  command: >
    gsutil ls "{{ bundle_root_url.rstrip('/') }}/manifest.yml"
  register: aip_cs_manifest_probe
  changed_when: false
  failed_when: aip_cs_manifest_probe.rc not in [0, 1]

- name: Set manifest_url from bundle_root_url probe result
  when:
    - aip_cs_manifest_url | length == 0
    - bundle_root_url | default('') | length > 0
    - aip_cs_manifest_probe.rc == 0
    - aip_cs_manifest_probe.stdout_lines | length > 0
  set_fact:
    aip_cs_manifest_url: "{{ aip_cs_manifest_probe.stdout_lines[0] }}"

# 2.3. Legacy: compose manifest_url from bundle_type if provided
- name: Compose manifest_url from bundle_type if provided (legacy)
  when:
    - aip_cs_manifest_url | length == 0
    - bundle_type | default('') | length > 0
  set_fact:
    aip_cs_manifest_url: "gs://{{ aip_cs_bucket }}/content/{{ bundle_type }}/{{ bundle_id }}/manifest.yml"

# 2.4. Legacy: auto-discover manifest in bucket by bundle_id
- name: Auto-discover manifest in bucket by bundle_id (legacy fallback)
  when:
    - aip_cs_manifest_url | length == 0
  delegate_to: "{{ aip_cs_controller_host | default('localhost') }}"
  environment:
    CLOUDSDK_CORE_PROJECT: "{{ aip_cs_gcp_project }}"
  command: >
    gsutil ls "gs://{{ aip_cs_bucket }}/content/**/{{ bundle_id }}/manifest.yml"
  register: aip_cs_manifest_ls
  changed_when: false
  failed_when: aip_cs_manifest_ls.rc not in [0, 1]

- name: Set manifest_url from auto-discovery result (legacy)
  when:
    - aip_cs_manifest_url | length == 0
    - aip_cs_manifest_ls.rc == 0
    - aip_cs_manifest_ls.stdout_lines | length > 0
  set_fact:
    aip_cs_manifest_url: "{{ aip_cs_manifest_ls.stdout_lines[0] }}"

- name: Fail if manifest_url is still empty
  when: aip_cs_manifest_url | length == 0
  fail:
    msg: >
      Could not determine manifest URL for bundle_id='{{ bundle_id }}'.
      Checked:
        - bundle_manifest_url='{{ bundle_manifest_url | default('') }}'
        - bundle_root_url='{{ bundle_root_url | default('') }}'
        - bundle_type='{{ bundle_type | default('') }}'
        - legacy auto-discovery under gs://{{ aip_cs_bucket }}/content/**/{{ bundle_id }}/manifest.yml.

- name: Ensure local working directory for manifest exists
  delegate_to: "{{ aip_cs_controller_host | default('localhost') }}"
  file:
    path: "{{ aip_cs_work_dir }}/{{ inventory_hostname }}/{{ bundle_safe_id }}"
    state: directory
    mode: "0755"

- name: Download manifest.yaml from GCS
  delegate_to: "{{ aip_cs_controller_host | default('localhost') }}"
  environment:
    CLOUDSDK_CORE_PROJECT: "{{ aip_cs_gcp_project }}"
  command: >
    gsutil cp "{{ aip_cs_manifest_url }}"
    "{{ aip_cs_work_dir }}/{{ inventory_hostname }}/{{ bundle_safe_id }}/manifest.yaml"
  register: aip_cs_manifest_dl
  changed_when: aip_cs_manifest_dl.rc == 0

- name: Fail if manifest download failed
  when: aip_cs_manifest_dl.rc != 0
  fail:
    msg: >
      Failed to download manifest from '{{ aip_cs_manifest_url }}'.
      gsutil rc={{ aip_cs_manifest_dl.rc }} stderr={{ aip_cs_manifest_dl.stderr | default('') }}

- name: Slurp manifest.yaml into a variable
  delegate_to: "{{ aip_cs_controller_host | default('localhost') }}"
  slurp:
    src: "{{ aip_cs_work_dir }}/{{ inventory_hostname }}/{{ bundle_safe_id }}/manifest.yaml"
  register: aip_cs_manifest_slurp

- name: Parse manifest YAML
  set_fact:
    aip_cs_manifest: "{{ aip_cs_manifest_slurp.content | b64decode | from_yaml }}"

- name: Normalize manifest fields
  set_fact:
    # Raw manifest subsections
    aip_cs_metadata: "{{ aip_cs_manifest.metadata | default({}) }}"
    aip_cs_source: "{{ aip_cs_manifest.source | default({}) }}"
    aip_cs_dest: "{{ aip_cs_manifest.dest | default({}) }}"
    aip_cs_rules: "{{ aip_cs_manifest.rules | default({}) }}"
    aip_cs_target: "{{ aip_cs_manifest.target | default({}) }}"
    aip_cs_post: "{{ aip_cs_manifest.post | default([]) }}"

    # Precedence (device > store > warehouse > region > base by default)
    aip_cs_precedence: >-
      {{
        aip_cs_manifest.precedence
        | default(['device', 'store', 'warehouse', 'region', 'base'])
      }}

# Apply behaviour flags from manifest rules, overridden by explicit vars if set
- name: Apply behaviour flags from manifest rules
  set_fact:
    enable_simple_backup: >-
      {{
        (
          vars.enable_simple_backup
          if ('enable_simple_backup' in vars)
          else (
            aip_cs_rules.enable_simple_backup
            if (aip_cs_rules is mapping and 'enable_simple_backup' in aip_cs_rules)
            else false
          )
        )
      }}
    prune_extraneous: >-
      {{
        (
          vars.prune_extraneous
          if ('prune_extraneous' in vars)
          else (
            aip_cs_rules.prune_extraneous
            if (aip_cs_rules is mapping and 'prune_extraneous' in aip_cs_rules)
            else false
          )
        )
      }}

# ---------------------------------------------------------------------------
# 3. Target gating
# ---------------------------------------------------------------------------

- name: Extract target gating lists
  set_fact:
    target_regions: "{{ aip_cs_target.regions | default([]) }}"
    target_warehouses: "{{ aip_cs_target.warehouses | default([]) }}"
    target_stores: "{{ aip_cs_target.stores | default([]) }}"
    target_devices: "{{ aip_cs_target.devices | default([]) }}"

# NOTE (important behaviour):
# - If manifest has NO targets => bundle applies to everyone (gating_ok = true).
# - If manifest HAS targets but we did NOT provide ANY slugs => bundle STILL applies
#   (we treat this device as "generic" and only apply base content, no overrides).
# - Only when we BOTH:
#     * have manifest targets, AND
#     * provide one or more slugs,
#   do we ENFORCE matching and potentially SKIP.

- name: Compute manifest/slug gating flags
  set_fact:
    aip_cs_manifest_has_targets: >-
      {{
        (target_regions | length > 0) or
        (target_warehouses | length > 0) or
        (target_stores | length > 0) or
        (target_devices | length > 0)
      }}
    aip_cs_slugs_provided: >-
      {{
        (region_slug | default('') | length > 0) or
        (warehouse_slug | default('') | length > 0) or
        (store_slug | default('') | length > 0) or
        (device_slug | default('') | length > 0)
      }}

- name: Debug targeting and slugs
  debug:
    msg:
      target_regions: "{{ target_regions }}"
      target_warehouses: "{{ target_warehouses }}"
      target_stores: "{{ target_stores }}"
      target_devices: "{{ target_devices }}"
      region_slug: "{{ region_slug }}"
      warehouse_slug: "{{ warehouse_slug }}"
      store_slug: "{{ store_slug }}"
      device_slug: "{{ device_slug }}"
      manifest_has_targets: "{{ aip_cs_manifest_has_targets }}"
      slugs_provided: "{{ aip_cs_slugs_provided }}"

- name: Evaluate targeting constraints
  set_fact:
    gating_ok: >-
      {{        
        (not aip_cs_manifest_has_targets)
        or

        (aip_cs_manifest_has_targets and not aip_cs_slugs_provided)
        or

        (
          aip_cs_manifest_has_targets
          and aip_cs_slugs_provided
          and (target_regions | length == 0
               or (region_slug | default('') | length > 0
                   and region_slug in target_regions))
          and (target_warehouses | length == 0
               or (warehouse_slug | default('') | length > 0
                   and warehouse_slug in target_warehouses))
          and (target_stores | length == 0
               or (store_slug | default('') | length > 0
                   and store_slug in target_stores))
          and (target_devices | length == 0
               or (device_slug | default('') | length > 0
                   and device_slug in target_devices))
        )
      }}

- name: Skip content sync because target gating does not match this device
  when: not gating_ok
  debug:
    msg: >
      Skipping bundle '{{ bundle_id }}' on host '{{ inventory_hostname }}'
      due to target gating not matching (region={{ region_slug }},
      warehouse={{ warehouse_slug }}, store={{ store_slug }},
      device={{ device_slug }}).

- name: Stop processing this host (gating)
  when: not gating_ok
  meta: end_host

# ---------------------------------------------------------------------------
# 4. Compute source paths and build overlay on controller
# ---------------------------------------------------------------------------

- name: Extract source paths from manifest
  set_fact:
    aip_cs_src_base_rel: "{{ aip_cs_source.base | default('') }}"
    aip_cs_src_region_rel: "{{ aip_cs_source.overrides.region | default('') }}"
    aip_cs_src_warehouse_rel: "{{ aip_cs_source.overrides.warehouse | default('') }}"
    aip_cs_src_store_rel: "{{ aip_cs_source.overrides.store | default('') }}"
    aip_cs_src_device_rel: "{{ aip_cs_source.overrides.device | default('') }}"

- name: Compute raw base_url from metadata
  set_fact:
    aip_cs_base_url_raw: "{{ aip_cs_metadata.base_url | default('') }}"

- name: Derive effective base_url
  set_fact:
    aip_cs_base_url: >-
      {%- if aip_cs_base_url_raw | length > 0 -%}
        {{ aip_cs_base_url_raw
           | regex_replace('^gs://YOUR_BUCKET', 'gs://' ~ aip_cs_bucket) }}
      {%- else -%}
        {{ aip_cs_manifest_url | regex_replace('/manifest.yml$', '') }}
      {%- endif -%}

- name: Fail if base_url is empty
  when: aip_cs_base_url | length == 0
  fail:
    msg: >
      Could not determine base_url for bundle_id='{{ bundle_id }}'.
      metadata.base_url is empty/placeholder and derivation from manifest_url failed.

- name: Resolve override paths with slugs
  set_fact:
    aip_cs_src_region_resolved: >-
      {{
        aip_cs_src_region_rel
        | default('')
        | replace('{region_slug}', region_slug | default(''))
      }}
    aip_cs_src_warehouse_resolved: >-
      {{
        aip_cs_src_warehouse_rel
        | default('')
        | replace('{region_slug}', region_slug | default(''))
        | replace('{warehouse_slug}', warehouse_slug | default(''))
      }}
    aip_cs_src_store_resolved: >-
      {{
        aip_cs_src_store_rel
        | default('')
        | replace('{region_slug}', region_slug | default(''))
        | replace('{warehouse_slug}', warehouse_slug | default(''))
        | replace('{store_slug}', store_slug | default(''))
      }}
    aip_cs_src_device_resolved: >-
      {{
        aip_cs_src_device_rel
        | default('')
        | replace('{region_slug}', region_slug | default(''))
        | replace('{warehouse_slug}', warehouse_slug | default(''))
        | replace('{store_slug}', store_slug | default(''))
        | replace('{device_slug}', device_slug | default(''))
      }}

- name: Debug resolved source paths
  debug:
    msg:
      base_rel: "{{ aip_cs_src_base_rel }}"
      region_resolved: "{{ aip_cs_src_region_resolved }}"
      warehouse_resolved: "{{ aip_cs_src_warehouse_resolved }}"
      store_resolved: "{{ aip_cs_src_store_resolved }}"
      device_resolved: "{{ aip_cs_src_device_resolved }}"

- name: Compute controller overlay root directory
  set_fact:
    aip_cs_controller_overlay_dir: >-
      {{ aip_cs_work_dir }}/{{ inventory_hostname }}/{{ bundle_safe_id }}/overlay

- name: Ensure overlay subdirs for base content and checksums exist
  delegate_to: "{{ aip_cs_controller_host | default('localhost') }}"
  file:
    path: "{{ item }}"
    state: directory
    mode: "0755"
  loop:
    - "{{ aip_cs_controller_overlay_dir }}/{{ aip_cs_src_base_rel }}"
    - "{{ aip_cs_controller_overlay_dir }}/checksums"

- name: Sync base content from GCS into overlay
  delegate_to: "{{ aip_cs_controller_host | default('localhost') }}"
  environment:
    CLOUDSDK_CORE_PROJECT: "{{ aip_cs_gcp_project }}"
  command: >
    gsutil -m rsync -r
    "{{ aip_cs_base_url }}/{{ aip_cs_src_base_rel }}"
    "{{ aip_cs_controller_overlay_dir }}/{{ aip_cs_src_base_rel }}/"
  register: aip_cs_base_rsync
  changed_when: true
  failed_when: aip_cs_base_rsync.rc != 0

- name: Debug base rsync output
  debug:
    var: aip_cs_base_rsync.stdout_lines

- name: Ensure region overrides overlay dir exists (if configured)
  when:
    - region_slug | default('') | length > 0
    - aip_cs_src_region_resolved | length > 0
  delegate_to: "{{ aip_cs_controller_host | default('localhost') }}"
  file:
    path: "{{ aip_cs_controller_overlay_dir }}/{{ aip_cs_src_region_resolved }}"
    state: directory
    mode: "0755"

- name: Sync region overrides into overlay (if configured)
  when:
    - region_slug | default('') | length > 0
    - aip_cs_src_region_resolved | length > 0
  delegate_to: "{{ aip_cs_controller_host | default('localhost') }}"
  environment:
    CLOUDSDK_CORE_PROJECT: "{{ aip_cs_gcp_project }}"
  command: >
    gsutil -m rsync -r
    "{{ aip_cs_base_url }}/{{ aip_cs_src_region_resolved }}"
    "{{ aip_cs_controller_overlay_dir }}/{{ aip_cs_src_region_resolved }}/"
  register: aip_cs_region_rsync
  changed_when: aip_cs_region_rsync.rc == 0
  failed_when: false

- name: Ensure warehouse overrides overlay dir exists (if configured)
  when:
    - warehouse_slug | default('') | length > 0
    - aip_cs_src_warehouse_resolved | length > 0
  delegate_to: "{{ aip_cs_controller_host | default('localhost') }}"
  file:
    path: "{{ aip_cs_controller_overlay_dir }}/{{ aip_cs_src_warehouse_resolved }}"
    state: directory
    mode: "0755"

- name: Sync warehouse overrides into overlay (if configured)
  when:
    - warehouse_slug | default('') | length > 0
    - aip_cs_src_warehouse_resolved | length > 0
  delegate_to: "{{ aip_cs_controller_host | default('localhost') }}"
  environment:
    CLOUDSDK_CORE_PROJECT: "{{ aip_cs_gcp_project }}"
  command: >
    gsutil -m rsync -r
    "{{ aip_cs_base_url }}/{{ aip_cs_src_warehouse_resolved }}"
    "{{ aip_cs_controller_overlay_dir }}/{{ aip_cs_src_warehouse_resolved }}/"
  register: aip_cs_warehouse_rsync
  changed_when: aip_cs_warehouse_rsync.rc == 0
  failed_when: false

- name: Ensure store overrides overlay dir exists (if configured)
  when:
    - store_slug | default('') | length > 0
    - aip_cs_src_store_resolved | length > 0
  delegate_to: "{{ aip_cs_controller_host | default('localhost') }}"
  file:
    path: "{{ aip_cs_controller_overlay_dir }}/{{ aip_cs_src_store_resolved }}"
    state: directory
    mode: "0755"

- name: Check if store overrides path exists in GCS
  when:
    - store_slug | default('') | length > 0
    - aip_cs_src_store_resolved | length > 0
  delegate_to: "{{ aip_cs_controller_host | default('localhost') }}"
  environment:
    CLOUDSDK_CORE_PROJECT: "{{ aip_cs_gcp_project }}"
  command: >
    gsutil ls "{{ aip_cs_base_url }}/{{ aip_cs_src_store_resolved }}/**"
  register: aip_cs_store_ls
  changed_when: false
  failed_when: false

- name: Sync store overrides into overlay (if configured)
  when:
    - store_slug | default('') | length > 0
    - aip_cs_src_store_resolved | length > 0
    - aip_cs_store_ls.rc == 0
  delegate_to: "{{ aip_cs_controller_host | default('localhost') }}"
  environment:
    CLOUDSDK_CORE_PROJECT: "{{ aip_cs_gcp_project }}"
  command: >
    gsutil -m rsync -r
    "{{ aip_cs_base_url }}/{{ aip_cs_src_store_resolved }}"
    "{{ aip_cs_controller_overlay_dir }}/{{ aip_cs_src_store_resolved }}/"
  register: aip_cs_store_rsync
  changed_when: aip_cs_store_rsync.rc == 0
  failed_when: false

- name: Ensure device overrides overlay dir exists (if configured)
  when:
    - device_slug | default('') | length > 0
    - aip_cs_src_device_resolved | length > 0
  delegate_to: "{{ aip_cs_controller_host | default('localhost') }}"
  file:
    path: "{{ aip_cs_controller_overlay_dir }}/{{ aip_cs_src_device_resolved }}"
    state: directory
    mode: "0755"

- name: Sync device overrides into overlay (if configured)
  when:
    - device_slug | default('') | length > 0
    - aip_cs_src_device_resolved | length > 0
  delegate_to: "{{ aip_cs_controller_host | default('localhost') }}"
  environment:
    CLOUDSDK_CORE_PROJECT: "{{ aip_cs_gcp_project }}"
  command: >
    gsutil -m rsync -r
    "{{ aip_cs_base_url }}/{{ aip_cs_src_device_resolved }}"
    "{{ aip_cs_controller_overlay_dir }}/{{ aip_cs_src_device_resolved }}/"
  register: aip_cs_device_rsync
  changed_when: aip_cs_device_rsync.rc == 0
  failed_when: false

- name: Check if sha256 checksum list exists in GCS
  delegate_to: "{{ aip_cs_controller_host | default('localhost') }}"
  environment:
    CLOUDSDK_CORE_PROJECT: "{{ aip_cs_gcp_project }}"
  command: >
    gsutil ls "{{ aip_cs_base_url }}/checksums/sha256.lst"
  register: aip_cs_checksum_ls
  changed_when: false
  failed_when: false

- name: Download checksum list from GCS (sha256.lst)
  when: aip_cs_checksum_ls.rc == 0
  delegate_to: "{{ aip_cs_controller_host | default('localhost') }}"
  environment:
    CLOUDSDK_CORE_PROJECT: "{{ aip_cs_gcp_project }}"
  command: >
    gsutil cp "{{ aip_cs_base_url }}/checksums/sha256.lst"
    "{{ aip_cs_controller_overlay_dir }}/checksums/sha256.lst"
  register: aip_cs_checksum_dl
  changed_when: aip_cs_checksum_dl.rc == 0

# ---------------------------------------------------------------------------
# 4b. Checksum verification (optional)
# ---------------------------------------------------------------------------

- name: Verify checksums if checksum list is present
  when: aip_cs_checksum_ls.rc == 0
  delegate_to: "{{ aip_cs_controller_host | default('localhost') }}"
  command: >
    sha256sum -c "checksums/sha256.lst"
  args:
    chdir: "{{ aip_cs_controller_overlay_dir }}"
  register: aip_cs_checksum_verify
  changed_when: false
  failed_when: false

- name: Set checksum verification result fact
  when: aip_cs_checksum_ls.rc == 0
  set_fact:
    aip_cs_checksums_ok: "{{ aip_cs_checksum_verify.rc == 0 }}"

- name: Debug checksum verification output
  when: aip_cs_checksum_ls.rc == 0
  debug:
    var: aip_cs_checksum_verify.stdout_lines

- name: Skip content sync because checksum verification failed
  when:
    - aip_cs_checksum_ls.rc == 0
    - (aip_cs_checksums_ok | default(true)) | bool == false
  debug:
    msg: >
      Skipping bundle '{{ bundle_id }}' on host '{{ inventory_hostname }}'
      because checksum verification failed (rc={{ aip_cs_checksum_verify.rc }}).

- name: Stop processing this host (checksum failure)
  when:
    - aip_cs_checksum_ls.rc == 0
    - (aip_cs_checksums_ok | default(true)) | bool == false
  meta: end_host

# ---------------------------------------------------------------------------
# 5. Overlay -> Jetson staging
# ---------------------------------------------------------------------------

- name: Ensure stage_dir exists on target
  become: true
  file:
    path: "{{ aip_cs_stage_dir }}"
    state: directory
    owner: "{{ aip_deploy_user }}"
    group: "{{ aip_deploy_user }}"
    mode: "0755"

- name: Build rsync base options for Jetson sync
  set_fact:
    aip_cs_rsync_opts:
      - "--archive"
      - "--delete"
      - "--partial"
      - "--partial-dir=.rsync-partial"
      - "--append-verify"
      - "--compress"

- name: Add bwlimit to rsync options if configured
  when: (aip_cs_rsync_bwlimit_kbps | int) > 0
  set_fact:
    aip_cs_rsync_opts: >-
      {{
        aip_cs_rsync_opts
        + ['--bwlimit=' ~ (aip_cs_rsync_bwlimit_kbps | int | string)]
      }}

- name: Add extra rsync options (if any)
  when: (aip_cs_rsync_extra_opts | default([])) | length > 0
  set_fact:
    aip_cs_rsync_opts: "{{ aip_cs_rsync_opts + aip_cs_rsync_extra_opts }}"

- name: Sync overlay from controller to Jetson staging
  synchronize:
    src: "{{ aip_cs_controller_overlay_dir }}/"
    dest: "{{ aip_cs_stage_dir }}/"
    mode: push
    rsync_opts: "{{ aip_cs_rsync_opts }}"
    use_ssh_args: yes
  delegate_to: "{{ aip_cs_controller_host | default('localhost') }}"

# ---------------------------------------------------------------------------
# 6. Promote staged content into dest_root (with backups, receipts, pruning)
# ---------------------------------------------------------------------------

- name: Compute raw dest_root template from manifest.dest.root
  set_fact:
    aip_cs_dest_root_template: "{{ aip_cs_dest.root | default('') }}"

# NEW BEHAVIOUR:
# - If dest_root contains known tokens ({deployments_root}, {current}) we expand them.
# - Otherwise we treat dest_root as a literal path.

- name: Render dest_root from template tokens (if present)
  when: "'{' in aip_cs_dest_root_template and '}' in aip_cs_dest_root_template"
  set_fact:
    aip_cs_dest_root: >-
      {{
        aip_cs_dest_root_template
        | replace('{deployments_root}', deployments_root)
        | replace('{current}', current)
      }}

- name: Use dest_root as literal path (no tokens)
  when: not ('{' in aip_cs_dest_root_template and '}' in aip_cs_dest_root_template)
  set_fact:
    aip_cs_dest_root: "{{ aip_cs_dest_root_template }}"

- name: Fail if dest_root is empty
  when: aip_cs_dest_root | length == 0
  fail:
    msg: >
      dest.root in manifest is empty after rendering placeholders.

- name: Ensure dest_root parent exists
  become: true
  file:
    path: "{{ aip_cs_dest_root | dirname }}"
    state: directory
    mode: "0755"

- name: Capture pre-existing content checksum (if any)
  stat:
    path: "{{ aip_cs_dest_root }}"
  register: aip_cs_dest_stat

- name: Backup existing content if dest_root exists and enable_simple_backup is true
  when:
    - enable_simple_backup | default(false) | bool
    - aip_cs_dest_stat.stat.exists
  become: true
  command: >
    cp -a "{{ aip_cs_dest_root }}" "{{ aip_cs_backup_dir }}"
  register: aip_cs_backup_cmd
  changed_when: aip_cs_backup_cmd.rc == 0
  failed_when: false

- name: Debug backup result
  when:
    - enable_simple_backup | default(false) | bool
  debug:
    var: aip_cs_backup_cmd

- name: Promote staged content into dest_root
  block:
    - name: Rsync staged content into dest_root
      become: true
      command: >
        rsync -a "{{ aip_cs_stage_dir }}/" "{{ aip_cs_dest_root }}/"
      register: aip_cs_dest_rsync
      changed_when: aip_cs_dest_rsync.rc == 0

    - name: Write/update managed index receipt
      copy:
        dest: "{{ aip_cs_managed_index_path }}"

        content: |
          {
            "bundle_id": "{{ bundle_id }}",
            "version": "{{ bundle_version }}",
            "dest_root": "{{ aip_cs_dest_root }}",
            "timestamp": "{{ aip_cs_timestamp }}",
            "host": "{{ inventory_hostname }}"
          }
        mode: "0644"

    - name: Run compose restart post-actions (if defined)
      become: true
      when:
        - (aip_compose_refresh_after_sync | default(false)) | bool
        - (aip_cs_post | default([])) | length > 0
      vars:
        _compose_items: >-
          {{
            (aip_cs_post | default([]))
            | selectattr('type', 'defined')
            | selectattr('type','equalto','compose')
            | list
          }}
      block:
        - name: Restart compose services as per manifest
          when: _compose_items | length > 0
          shell: |
            set -e
            cd "{{ aip_cs_dest_root }}"
            {% for action in _compose_items %}
            docker compose restart {{ action.service | default('') }}
            {% endfor %}
          register: aip_cs_post_compose
          changed_when: aip_cs_post_compose.rc == 0

  rescue:
    - name: Roll back from backup if available
      when:
        - enable_simple_backup | default(false) | bool
        - aip_cs_backup_cmd is defined
        - aip_cs_backup_cmd.rc == 0
      block:
        - name: Remove partially updated dest_root
          become: true
          file:
            path: "{{ aip_cs_dest_root }}"
            state: absent

        - name: Restore backup to dest_root
          become: true
          command: >
            cp -a "{{ aip_cs_backup_dir }}" "{{ aip_cs_dest_root }}"
          register: aip_cs_restore_cmd
          changed_when: aip_cs_restore_cmd.rc == 0
          failed_when: aip_cs_restore_cmd.rc != 0

    - name: Fail role due to promotion error
      fail:
        msg: >
          Failed to promote staged content into '{{ aip_cs_dest_root }}'.
          See previous task errors for details.

# ---------------------------------------------------------------------------
# 7. Surgical prune of extraneous content (optional)
# ---------------------------------------------------------------------------

- name: Prune content not in new manifest (if enabled)
  when:
    - prune_extraneous | default(false) | bool
  block:
    - name: Compute list of live files from stage_dir
      find:
        paths: "{{ aip_cs_stage_dir }}"
        file_type: file
      register: aip_cs_live_files

    - name: Compute list of existing files in dest_root
      find:
        paths: "{{ aip_cs_dest_root }}"
        file_type: file
      register: aip_cs_dest_files

    - name: Build relative path list for live files (from stage_dir)
      set_fact:
        aip_cs_live_rel_paths: >-
          {{
            aip_cs_live_files.files
            | map(attribute='path')
            | map('regex_replace', '^' ~ aip_cs_stage_dir ~ '/', '')
            | list
          }}

    - name: Build relative path list for dest files (from dest_root)
      set_fact:
        aip_cs_dest_rel_paths: >-
          {{
            aip_cs_dest_files.files
            | map(attribute='path')
            | map('regex_replace', '^' ~ aip_cs_dest_root ~ '/', '')
            | list
          }}

    - name: Mark extraneous files (present in dest_root but not in stage_dir)
      set_fact:
        aip_cs_extraneous_rel_paths: >-
          {{
            aip_cs_dest_rel_paths
            | difference(aip_cs_live_rel_paths)
          }}

    - name: Debug extraneous files (if any)
      debug:
        var: aip_cs_extraneous_rel_paths
      when: (aip_cs_extraneous_rel_paths | default([])) | length > 0

    - name: Remove extraneous files
      become: true
      file:
        path: "{{ aip_cs_dest_root }}/{{ item }}"
        state: absent
      loop: "{{ aip_cs_extraneous_rel_paths | default([]) }}"

# ---------------------------------------------------------------------------
# 8. Health check (optional)
# ---------------------------------------------------------------------------

- name: Run healthcheck command (if enabled)
  when:
    - healthcheck.enabled | default(false) | bool
    - healthcheck.command | default('') | length > 0
  block:
    - name: Execute healthcheck command
      shell: "{{ healthcheck.command }}"
      register: aip_cs_healthcheck
      failed_when: aip_cs_healthcheck.rc != 0
      changed_when: false

    - name: Debug healthcheck output
      debug:
        var: aip_cs_healthcheck.stdout_lines

# ---------------------------------------------------------------------------
# 9. Cleanup / done
# ---------------------------------------------------------------------------

- name: "AIP content sync | Completed"
  debug:
    msg: >
      AIP content sync completed for bundle_id='{{ bundle_id }}'
      and target_version='{{ bundle_version }}'.\n
