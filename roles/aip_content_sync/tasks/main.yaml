---
# Main orchestration tasks for AIP content sync.
# This role:
#   - Downloads a manifest from GCS.
#   - Parses metadata, source/dest info, and rules.
#   - Builds a GCS -> controller overlay.
#   - Stages content on the Jetson.
#   - Promotes staged content into final dest_root.
#   - Manages receipts, backups, and surgical deletion of old content.

- name: "AIP content sync | Start"
  debug:
    msg: >
      Starting AIP content sync for bundle_id='{{ bundle_id }}'
      and target_version='{{ target_version }}'.

- name: Ensure AIP base state directories exist
  file:
    path: "{{ item }}"
    state: directory
    mode: "0755"
  loop:
    - "{{ aip_state_dir }}"
    - "{{ stage_root }}"
    - "{{ backups_root }}"
    - "{{ receipts_root }}"

- name: Compute bundle_id hash-safe name
  set_fact:
    bundle_safe_id: "{{ bundle_id | regex_replace('[^a-zA-Z0-9_.-]', '_') }}"

- name: Compute target version string
  set_fact:
    bundle_version: "{{ target_version | default('current') }}"

- name: Compute stage_dir for this run
  set_fact:
    aip_cs_stage_dir: "{{ stage_root }}/{{ bundle_safe_id }}@{{ bundle_version }}"

- name: Compute backup_dir (timestamped) for this run
  set_fact:
    aip_cs_backup_dir: "{{ backups_root }}/{{ bundle_safe_id }}@{{ bundle_version }}-{{ ansible_date_time.iso8601_basic }}"

- name: Compute managed index path for receipts
  set_fact:
    aip_cs_managed_index_path: "{{ receipts_root }}/{{ managed_index_name }}"

# ---------------------------------------------------------------------------
# 1. Download and parse manifest
# ---------------------------------------------------------------------------

- name: Ensure local working directory for manifest exists
  file:
    path: "{{ aip_cs_work_dir | default('/tmp/aip_content') }}/{{ inventory_hostname }}/{{ bundle_safe_id }}"
    state: directory
    mode: "0755"
  delegate_to: "{{ aip_cs_controller_host | default('localhost') }}"

- name: Compute manifest URL (GCS object path)
  set_fact:
    aip_cs_manifest_url: "{{ aip_cs_gcs_manifest_url | default(aip_cs_manifest_default_url) }}"

- name: Download manifest.yaml from GCS
  delegate_to: "{{ aip_cs_controller_host | default('localhost') }}"
  environment:
    CLOUDSDK_CORE_PROJECT: "{{ aip_cs_gcp_project }}"
  command: >
    gsutil cp "{{ aip_cs_manifest_url }}"
    "{{ aip_cs_work_dir | default('/tmp/aip_content') }}/{{ inventory_hostname }}/{{ bundle_safe_id }}/manifest.yaml"
  register: aip_cs_manifest_dl
  changed_when: aip_cs_manifest_dl.rc == 0

- name: Fail if manifest download failed
  when: aip_cs_manifest_dl.rc != 0
  fail:
    msg: >
      Failed to download manifest from '{{ aip_cs_manifest_url }}'.
      gsutil rc={{ aip_cs_manifest_dl.rc }} stderr={{ aip_cs_manifest_dl.stderr | default('') }}

- name: Slurp manifest.yaml into a variable
  delegate_to: "{{ aip_cs_controller_host | default('localhost') }}"
  slurp:
    src: "{{ aip_cs_work_dir | default('/tmp/aip_content') }}/{{ inventory_hostname }}/{{ bundle_safe_id }}/manifest.yaml"
  register: aip_cs_manifest_slurp

- name: Parse manifest YAML
  set_fact:
    aip_cs_manifest: "{{ aip_cs_manifest_slurp['content'] | b64decode | from_yaml }}"

- name: Normalize manifest fields
  set_fact:
    # Raw manifest subsections
    aip_cs_metadata: "{{ aip_cs_manifest.metadata | default({}) }}"
    aip_cs_source: "{{ aip_cs_manifest.source | default({}) }}"
    aip_cs_dest: "{{ aip_cs_manifest.dest | default({}) }}"
    aip_cs_rules: "{{ aip_cs_manifest.rules | default({}) }}"
    aip_cs_target: "{{ aip_cs_manifest.target | default({}) }}"
    aip_cs_post: "{{ aip_cs_manifest.post | default([]) }}"

    # Precedence (device > store > warehouse > region > base by default)
    aip_cs_precedence: >-
      {{
        aip_cs_manifest.precedence
        | default(['device', 'store', 'warehouse', 'region', 'base'])
      }}

# ---------------------------------------------------------------------------
# 2. Resolve target facts (region, warehouse, store, device)
# ---------------------------------------------------------------------------

- name: Resolve target device/store/warehouse/region from target section
  set_fact:
    region_slug: "{{ aip_cs_target.region_slug | default('') }}"
    warehouse_slug: "{{ aip_cs_target.warehouse_slug | default('') }}"
    store_slug: "{{ aip_cs_target.store_slug | default('') }}"
    device_slug: "{{ aip_cs_target.device_slug | default('') }}"

- name: Debug resolved target slugs
  debug:
    msg:
      region_slug: "{{ region_slug }}"
      warehouse_slug: "{{ warehouse_slug }}"
      store_slug: "{{ store_slug }}"
      device_slug: "{{ device_slug }}"

# ---------------------------------------------------------------------------
# 3. Compute source paths (base + overrides) relative to base_url
# ---------------------------------------------------------------------------

- name: Extract source paths from manifest
  set_fact:
    aip_cs_src_base_rel: "{{ aip_cs_source.base | default('') }}"
    aip_cs_src_region_rel: "{{ aip_cs_source.overrides.region | default('') }}"
    aip_cs_src_warehouse_rel: "{{ aip_cs_source.overrides.warehouse | default('') }}"
    aip_cs_src_store_rel: "{{ aip_cs_source.overrides.store | default('') }}"
    aip_cs_src_device_rel: "{{ aip_cs_source.overrides.device | default('') }}"

- name: Compute base_url from metadata
  set_fact:
    aip_cs_base_url: "{{ aip_cs_metadata.base_url | default('') }}"

- name: Fail if base_url is empty
  when: aip_cs_base_url | length == 0
  fail:
    msg: >
      metadata.base_url is empty in manifest. Cannot proceed.

- name: Resolve override paths with slugs
  set_fact:
    aip_cs_src_region_resolved: >-
      {{
        aip_cs_src_region_rel
        | default('')
        | replace('{region_slug}', region_slug | default(''))
      }}
    aip_cs_src_warehouse_resolved: >-
      {{
        aip_cs_src_warehouse_rel
        | default('')
        | replace('{region_slug}', region_slug | default(''))
        | replace('{warehouse_slug}', warehouse_slug | default(''))
      }}
    aip_cs_src_store_resolved: >-
      {{
        aip_cs_src_store_rel
        | default('')
        | replace('{region_slug}', region_slug | default(''))
        | replace('{warehouse_slug}', warehouse_slug | default(''))
        | replace('{store_slug}', store_slug | default(''))
      }}
    aip_cs_src_device_resolved: >-
      {{
        aip_cs_src_device_rel
        | default('')
        | replace('{region_slug}', region_slug | default(''))
        | replace('{warehouse_slug}', warehouse_slug | default(''))
        | replace('{store_slug}', store_slug | default(''))
        | replace('{device_slug}', device_slug | default(''))
      }}

- name: Debug resolved source paths
  debug:
    msg:
      base_rel: "{{ aip_cs_src_base_rel }}"
      region_resolved: "{{ aip_cs_src_region_resolved }}"
      warehouse_resolved: "{{ aip_cs_src_warehouse_resolved }}"
      store_resolved: "{{ aip_cs_src_store_resolved }}"
      device_resolved: "{{ aip_cs_src_device_resolved }}"

# ---------------------------------------------------------------------------
# 4. Build overlay on controller (GCS -> controller overlay dir)
# ---------------------------------------------------------------------------

- name: Compute controller overlay root directory
  set_fact:
    aip_cs_controller_overlay_dir: >-
      {{ aip_cs_work_dir | default('/tmp/aip_content') }}/{{ inventory_hostname }}/{{ bundle_safe_id }}/overlay

- name: Ensure overlay subdirs for base content and checksums exist
  delegate_to: "{{ aip_cs_controller_host | default('localhost') }}"
  file:
    path: "{{ item }}"
    state: directory
    mode: "0755"
  loop:
    - "{{ aip_cs_controller_overlay_dir }}/{{ aip_cs_src_base_rel }}"
    - "{{ aip_cs_controller_overlay_dir }}/checksums"

- name: Sync base content from GCS into overlay
  delegate_to: "{{ aip_cs_controller_host | default('localhost') }}"
  environment:
    CLOUDSDK_CORE_PROJECT: "{{ aip_cs_gcp_project }}"
  command: >
    gsutil -m rsync -r
    "{{ aip_cs_base_url }}/{{ aip_cs_src_base_rel }}"
    "{{ aip_cs_controller_overlay_dir }}/{{ aip_cs_src_base_rel }}/"
  register: aip_cs_base_rsync
  changed_when: true
  failed_when: aip_cs_base_rsync.rc != 0

- name: Debug base rsync output
  debug:
    var: aip_cs_base_rsync.stdout_lines

- name: Ensure region overrides overlay dir exists (if configured)
  when:
    - region_slug | default('') | length > 0
    - aip_cs_src_region_resolved | length > 0
  delegate_to: "{{ aip_cs_controller_host | default('localhost') }}"
  file:
    path: "{{ aip_cs_controller_overlay_dir }}/{{ aip_cs_src_region_resolved }}"
    state: directory
    mode: "0755"

- name: Sync region overrides into overlay (if configured)
  when:
    - region_slug | default('') | length > 0
    - aip_cs_src_region_resolved | length > 0
  delegate_to: "{{ aip_cs_controller_host | default('localhost') }}"
  environment:
    CLOUDSDK_CORE_PROJECT: "{{ aip_cs_gcp_project }}"
  command: >
    gsutil -m rsync -r
    "{{ aip_cs_base_url }}/{{ aip_cs_src_region_resolved }}"
    "{{ aip_cs_controller_overlay_dir }}/{{ aip_cs_src_region_resolved }}/"
  register: aip_cs_region_rsync
  changed_when: aip_cs_region_rsync.rc == 0
  failed_when: false

- name: Ensure warehouse overrides overlay dir exists (if configured)
  when:
    - warehouse_slug | default('') | length > 0
    - aip_cs_src_warehouse_resolved | length > 0
  delegate_to: "{{ aip_cs_controller_host | default('localhost') }}"
  file:
    path: "{{ aip_cs_controller_overlay_dir }}/{{ aip_cs_src_warehouse_resolved }}"
    state: directory
    mode: "0755"

- name: Sync warehouse overrides into overlay (if configured)
  when:
    - warehouse_slug | default('') | length > 0
    - aip_cs_src_warehouse_resolved | length > 0
  delegate_to: "{{ aip_cs_controller_host | default('localhost') }}"
  environment:
    CLOUDSDK_CORE_PROJECT: "{{ aip_cs_gcp_project }}"
  command: >
    gsutil -m rsync -r
    "{{ aip_cs_base_url }}/{{ aip_cs_src_warehouse_resolved }}"
    "{{ aip_cs_controller_overlay_dir }}/{{ aip_cs_src_warehouse_resolved }}/"
  register: aip_cs_warehouse_rsync
  changed_when: aip_cs_warehouse_rsync.rc == 0
  failed_when: false

- name: Ensure store overrides overlay dir exists (if configured)
  when:
    - store_slug | default('') | length > 0
    - aip_cs_src_store_resolved | length > 0
  delegate_to: "{{ aip_cs_controller_host | default('localhost') }}"
  file:
    path: "{{ aip_cs_controller_overlay_dir }}/{{ aip_cs_src_store_resolved }}"
    state: directory
    mode: "0755"

- name: Check if store overrides path exists in GCS
  when:
    - store_slug | default('') | length > 0
    - aip_cs_src_store_resolved | length > 0
  delegate_to: "{{ aip_cs_controller_host | default('localhost') }}"
  environment:
    CLOUDSDK_CORE_PROJECT: "{{ aip_cs_gcp_project }}"
  command: >
    gsutil ls "{{ aip_cs_base_url }}/{{ aip_cs_src_store_resolved }}/**"
  register: aip_cs_store_ls
  changed_when: false
  failed_when: false

- name: Sync store overrides into overlay (if configured)
  when:
    - store_slug | default('') | length > 0
    - aip_cs_src_store_resolved | length > 0
    - aip_cs_store_ls.rc == 0
  delegate_to: "{{ aip_cs_controller_host | default('localhost') }}"
  environment:
    CLOUDSDK_CORE_PROJECT: "{{ aip_cs_gcp_project }}"
  command: >
    gsutil -m rsync -r
    "{{ aip_cs_base_url }}/{{ aip_cs_src_store_resolved }}"
    "{{ aip_cs_controller_overlay_dir }}/{{ aip_cs_src_store_resolved }}/"
  register: aip_cs_store_rsync
  changed_when: aip_cs_store_rsync.rc == 0
  failed_when: false

- name: Ensure device overrides overlay dir exists (if configured)
  when:
    - device_slug | default('') | length > 0
    - aip_cs_src_device_resolved | length > 0
  delegate_to: "{{ aip_cs_controller_host | default('localhost') }}"
  file:
    path: "{{ aip_cs_controller_overlay_dir }}/{{ aip_cs_src_device_resolved }}"
    state: directory
    mode: "0755"

- name: Sync device overrides into overlay (if configured)
  when:
    - device_slug | default('') | length > 0
    - aip_cs_src_device_resolved | length > 0
  delegate_to: "{{ aip_cs_controller_host | default('localhost') }}"
  environment:
    CLOUDSDK_CORE_PROJECT: "{{ aip_cs_gcp_project }}"
  command: >
    gsutil -m rsync -r
    "{{ aip_cs_base_url }}/{{ aip_cs_src_device_resolved }}"
    "{{ aip_cs_controller_overlay_dir }}/{{ aip_cs_src_device_resolved }}/"
  register: aip_cs_device_rsync
  changed_when: aip_cs_device_rsync.rc == 0
  failed_when: false

# ---------------------------------------------------------------------------
# 5. Overlay -> Jetson staging
# ---------------------------------------------------------------------------

- name: Ensure stage_dir exists on target
  file:
    path: "{{ aip_cs_stage_dir }}"
    state: directory
    mode: "0755"

- name: Sync overlay from controller to Jetson staging
  synchronize:
    src: "{{ aip_cs_controller_overlay_dir }}/"
    dest: "{{ aip_cs_stage_dir }}/"
    mode: push
    rsync_opts:
      - "--archive"
      - "--delete"
  delegate_to: "{{ aip_cs_controller_host | default('localhost') }}"

# ---------------------------------------------------------------------------
# 6. Promote staged content into dest_root (with backups, receipts, pruning)
# ---------------------------------------------------------------------------

- name: Compute dest_root from manifest.dest.root
  set_fact:
    aip_cs_dest_root: "{{ aip_cs_dest.root }}"

- name: Fail if dest_root is outside allowed roots
  when: aip_cs_dest_root | length == 0 or (aip_cs_dest_root | regex_search('^(' + (allowed_roots | join('|')) + ')') is not truthy)
  fail:
    msg: >
      dest.root='{{ aip_cs_dest_root }}' is empty or outside allowed_roots={{ allowed_roots }}.

- name: Ensure dest_root parent exists
  file:
    path: "{{ aip_cs_dest_root | dirname }}"
    state: directory
    mode: "0755"

- name: Capture pre-existing content checksum (if any)
  stat:
    path: "{{ aip_cs_dest_root }}"
  register: aip_cs_dest_stat

- name: Backup existing content if dest_root exists and enable_simple_backup is true
  when:
    - enable_simple_backup | default(false) | bool
    - aip_cs_dest_stat.stat.exists
  command: >
    cp -a "{{ aip_cs_dest_root }}" "{{ aip_cs_backup_dir }}"
  register: aip_cs_backup_cmd
  changed_when: aip_cs_backup_cmd.rc == 0
  failed_when: false

- name: Debug backup result
  when:
    - enable_simple_backup | default(false) | bool
  debug:
    var: aip_cs_backup_cmd

- name: Promote staged content into dest_root
  block:
    - name: Rsync staged content into dest_root
      command: >
        rsync -a "{{ aip_cs_stage_dir }}/" "{{ aip_cs_dest_root }}/"
      register: aip_cs_dest_rsync
      changed_when: aip_cs_dest_rsync.rc == 0

    - name: Write/update managed index receipt
      copy:
        dest: "{{ aip_cs_managed_index_path }}"
        content: |
          {
            "bundle_id": "{{ bundle_id }}",
            "version": "{{ bundle_version }}",
            "dest_root": "{{ aip_cs_dest_root }}",
            "timestamp": "{{ ansible_date_time.iso8601 }}",
            "host": "{{ inventory_hostname }}"
          }
        mode: "0644"

    # 6.10. Post actions (docker compose restart, etc.)
    - name: Run compose restart post-actions (if defined)
      become: true
      when:
        - (aip_compose_refresh_after_sync | default(false)) | bool
        - (aip_cs_post | default([])) | length > 0
      vars:
        _compose_items: >-
          {{
            (aip_cs_post | default([]))
            | selectattr('type', 'defined')
            | selectattr('type','equalto','compose')
            | list
          }}
      block:
        - name: Restart compose services as per manifest
          when: _compose_items | length > 0
          shell: |
            set -e
            cd "{{ aip_cs_dest_root }}"
            {% for action in _compose_items %}
            docker compose restart {{ action.service | default('') }}
            {% endfor %}
          register: aip_cs_post_compose
          changed_when: aip_cs_post_compose.rc == 0

  rescue:
    - name: Roll back from backup if available
      when:
        - enable_simple_backup | default(false) | bool
        - aip_cs_backup_cmd is defined
        - aip_cs_backup_cmd.rc == 0
      block:
        - name: Remove partially updated dest_root
          file:
            path: "{{ aip_cs_dest_root }}"
            state: absent

        - name: Restore backup to dest_root
          command: >
            cp -a "{{ aip_cs_backup_dir }}" "{{ aip_cs_dest_root }}"
          register: aip_cs_restore_cmd
          changed_when: aip_cs_restore_cmd.rc == 0
          failed_when: aip_cs_restore_cmd.rc != 0

    - name: Fail role due to promotion error
      fail:
        msg: >
          Failed to promote staged content into '{{ aip_cs_dest_root }}'.
          See previous task errors for details.

# ---------------------------------------------------------------------------
# 7. Surgical prune of extraneous content (optional)
# ---------------------------------------------------------------------------

- name: Prune content not in new manifest (if enabled)
  when:
    - prune_extraneous | default(false) | bool
  block:
    - name: Compute list of live files from stage_dir
      find:
        paths: "{{ aip_cs_stage_dir }}"
        file_type: file
      register: aip_cs_live_files

    - name: Compute list of existing files in dest_root
      find:
        paths: "{{ aip_cs_dest_root }}"
        file_type: file
      register: aip_cs_dest_files

    - name: Mark extraneous files (present in dest_root but not in stage_dir)
      set_fact:
        aip_cs_extraneous_files: >-
          {{
            aip_cs_dest_files.files
            | map(attribute='path')
            | difference(
                aip_cs_live_files.files | map('extract', attribute='path')
              )
          }}

    - name: Remove extraneous files
      file:
        path: "{{ item }}"
        state: absent
      loop: "{{ aip_cs_extraneous_files | default([]) }}"

# ---------------------------------------------------------------------------
# 8. Health check (optional)
# ---------------------------------------------------------------------------

- name: Run healthcheck command (if enabled)
  when:
    - healthcheck.enabled | default(false) | bool
    - healthcheck.command | default('') | length > 0
  block:
    - name: Execute healthcheck command
      shell: "{{ healthcheck.command }}"
      register: aip_cs_healthcheck
      failed_when: aip_cs_healthcheck.rc != 0
      changed_when: false

    - name: Debug healthcheck output
      debug:
        var: aip_cs_healthcheck.stdout_lines

# ---------------------------------------------------------------------------
# 9. Cleanup / done
# ---------------------------------------------------------------------------

- name: "AIP content sync | Completed"
  debug:
    msg: >
      AIP content sync completed for bundle_id='{{ bundle_id }}'
      and target_version='{{ bundle_version }}'.
