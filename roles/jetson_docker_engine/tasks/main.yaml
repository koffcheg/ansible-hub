---
# Remove any distro-provided Docker packages
- name: Remove distro Docker packages
  become: true
  apt:
    name:
      - docker
      - docker.io
      - docker-engine
      - containerd
      - runc
    state: absent
  ignore_errors: true

# Download official static Docker tarball
- name: Download Docker static binary tarball
  become: true
  get_url:
    url: "{{ jetson_docker_url }}"
    dest: "/tmp/docker-{{ jetson_docker_version }}.tgz"
    mode: "0644"

# Prepare temp directory for extraction
- name: Ensure Docker temp directory exists
  become: true
  file:
    path: "/tmp/docker-{{ jetson_docker_version }}"
    state: directory
    mode: "0755"

# Extract Docker tarball
- name: Extract Docker
  become: true
  unarchive:
    src: "/tmp/docker-{{ jetson_docker_version }}.tgz"
    dest: "/tmp/docker-{{ jetson_docker_version }}"
    remote_src: true
    creates: "/tmp/docker-{{ jetson_docker_version }}/docker"

# Install Docker binaries into /usr/local/bin
- name: Install Docker binaries to /usr/local/bin
  become: true
  copy:
    src: "/tmp/docker-{{ jetson_docker_version }}/docker/"
    dest: /usr/local/bin/
    owner: root
    group: root
    mode: "0755"
    remote_src: true

# Ensure Docker config directory exists
- name: Ensure Docker config directory exists
  become: true
  file:
    path: /etc/docker
    state: directory
    owner: root
    group: root
    mode: "0755"

# Install daemon.json (Docker daemon configuration)
# This will restart Docker via handler when changed
- name: Install daemon.json
  become: true
  copy:
    src: daemon.json
    dest: "{{ jetson_docker_daemon_config }}"
    owner: root
    group: root
    mode: "0644"
  notify: restart docker

# Install docker systemd unit from Jinja2 template
- name: Install docker systemd unit
  become: true
  template:
    src: docker.service.j2
    dest: "{{ jetson_docker_unit_path }}"
    owner: root
    group: root
    mode: "0644"

# Reload systemd to pick up new docker.service unit
- name: Reload systemd daemon for docker
  become: true
  systemd:
    daemon_reload: true

# Ensure docker.service is enabled and running
- name: Ensure docker.service is enabled and running
  become: true
  systemd:
    name: docker.service
    enabled: true
    state: started

# TLS certs for Docker API (localhost)
- name: Create /opt/certs directory
  become: true
  file:
    path: /opt/certs
    state: directory
    owner: root
    group: root
    mode: "0755"

- name: Generate self-signed cert and key for localhost
  become: true
  command: >
    openssl req -x509 -nodes -days 365
    -newkey rsa:2048
    -keyout /opt/certs/localhost.key.pem
    -out /opt/certs/localhost.cert.pem
    -subj "/CN=localhost"
  args:
    creates: /opt/certs/localhost.key.pem

- name: Fix ownership and permissions of certs
  become: true
  file:
    path: "{{ item }}"
    owner: root
    group: root
    mode: "0644"
  loop:
    - /opt/certs/localhost.cert.pem
    - /opt/certs/localhost.key.pem
