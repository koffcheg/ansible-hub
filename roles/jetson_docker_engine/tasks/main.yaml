---
- name: Remove distro Docker packages (if any) - optional
  become: true
  apt:
    name:
      - docker
      - docker.io
      - docker-engine
      - containerd
      - runc
    state: absent
  ignore_errors: true

- name: Download Docker static binary tarball
  become: true
  get_url:
    url: "{{ jetson_docker_url }}"
    dest: "/tmp/docker-{{ jetson_docker_version }}.tgz"
    mode: "0644"

- name: Ensure Docker temp directory exists
  become: true
  file:
    path: "/tmp/docker-{{ jetson_docker_version }}"
    state: directory
    mode: "0755"

- name: Extract Docker
  become: true
  unarchive:
    src: "/tmp/docker-{{ jetson_docker_version }}.tgz"
    dest: "/tmp/docker-{{ jetson_docker_version }}"
    remote_src: true
    creates: "/tmp/docker-{{ jetson_docker_version }}/docker"

- name: Install Docker binaries to /usr/local/bin
  become: true
  copy:
    src: "/tmp/docker-{{ jetson_docker_version }}/docker/"
    dest: /usr/local/bin/
    owner: root
    group: root
    mode: "0755"
    remote_src: true

- name: Ensure docker.service is enabled and running
  become: true
  systemd:
    name: docker
    enabled: true
    state: started

# 1) Ensure /etc/docker exists (you probably already have this)
- name: Ensure Docker config directory exists
  become: true
  file:
    path: /etc/docker
    state: directory
    owner: root
    group: root
    mode: "0755"

# 2) Install daemon.json (keep your current version, just add notify)
- name: Install daemon.json
  become: true
  copy:
    src: daemon.json  # or template: if you already use j2 here
    dest: "{{ jetson_docker_daemon_config }}"
    owner: root
    group: root
    mode: "0644"
  notify: restart docker

# 3) Install docker.service from j2 template
- name: Install docker systemd unit
  become: true
  template:
    src: docker.service.j2
    dest: "{{ jetson_docker_unit_path }}"
    owner: root
    group: root
    mode: "0644"
  notify: reload systemd for docker

# 4) Make sure systemd knows about the unit
- name: Reload systemd daemon for docker
  become: true
  systemd:
    daemon_reload: true

# 5) Ensure docker.service is enabled and running
- name: Ensure docker.service is enabled and running
  become: true
  systemd:
    name: docker.service
    enabled: true
    state: started

# TLS certs for docker as per doc
- name: Create /opt/certs directory
  become: true
  file:
    path: /opt/certs
    state: directory
    owner: root
    group: root
    mode: "0755"

- name: Generate self-signed cert and key for localhost
  become: true
  command: >
    openssl req -x509 -nodes -days 365
    -newkey rsa:2048
    -keyout /opt/certs/localhost.key.pem
    -out /opt/certs/localhost.cert.pem
    -subj "/CN=localhost"
  args:
    creates: /opt/certs/localhost.key.pem

- name: Fix ownership and permissions of certs
  become: true
  file:
    path: "{{ item }}"
    owner: root
    group: root
    mode: "0644"
  loop:
    - /opt/certs/localhost.cert.pem
    - /opt/certs/localhost.key.pem
