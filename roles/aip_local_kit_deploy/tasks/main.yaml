---
# 0) Validate archive param
- name: Fail if kit archive not provided
  ansible.builtin.fail:
    msg: |
      You must pass:
        -e "aip_kit_archive=<file>.tar.zst"
  when: aip_kit_archive is not defined or aip_kit_archive | length == 0

# 1) Compute archive path
- name: Compute full archive path
  ansible.builtin.set_fact:
    kit_archive_path: "{{ aip_eject_kits_root }}/{{ aip_kit_archive }}"

- name: Check archive exists
  ansible.builtin.stat:
    path: "{{ kit_archive_path }}"
  register: kit_stat

- name: Fail if archive missing
  ansible.builtin.fail:
    msg: "Archive '{{ kit_archive_path }}' not found on Jetson."
  when: not kit_stat.stat.exists

# 2) Derive deployment directory name (SPLIT into two tasks!)
- name: Derive kit basename
  ansible.builtin.set_fact:
    kit_basename: "{{ aip_kit_archive | regex_replace('\\.tar\\.zst$', '') }}"

- name: Derive deployment directory
  ansible.builtin.set_fact:
    deploy_dir: "{{ aip_deploy_root }}/{{ kit_basename }}"

- name: Debug derived paths
  ansible.builtin.debug:
    msg:
      - "kit_archive_path = {{ kit_archive_path }}"
      - "kit_basename    = {{ kit_basename }}"
      - "deploy_dir      = {{ deploy_dir }}"

# 3) Ensure deploy root exists
- name: Ensure deployments root exists
  ansible.builtin.file:
    path: "{{ aip_deploy_root }}"
    state: directory
    owner: "{{ aip_deploy_user }}"
    group: "{{ aip_deploy_user }}"
    mode: "0755"

# 4) Create version dir
- name: Create deploy_dir
  ansible.builtin.file:
    path: "{{ deploy_dir }}"
    state: directory
    owner: "{{ aip_deploy_user }}"
    group: "{{ aip_deploy_user }}"
    mode: "0755"

# 5) Extract archive
- name: Extract kit archive
  become: true
  become_user: "{{ aip_deploy_user }}"
  ansible.builtin.shell: >
    tar -I zstd -xf "{{ kit_archive_path }}"
    -C "{{ deploy_dir }}"
    --strip-components=1
  args:
    executable: /bin/bash

# 6) Run installer
- name: Run jetson installer
  become: true
  become_user: "{{ aip_deploy_user }}"
  ansible.builtin.shell: >
    ./main.sh
    --auto
    --store-id {{ aip_store_id }}
    "{{ deploy_dir }}"
  args:
    chdir: "{{ deploy_dir }}/jetson_installer"
    executable: /bin/bash

# 7) Update symlink
- name: Update 'current' symlink
  become: true
  ansible.builtin.file:
    src: "{{ deploy_dir }}"
    dest: "{{ aip_deploy_root }}/current"
    state: link
    force: true

# 8) Write receipt
- name: Write deploy receipt
  become: true
  ansible.builtin.copy:
    dest: "{{ deploy_dir }}/deploy.receipt"
    owner: "{{ aip_deploy_user }}"
    group: "{{ aip_deploy_user }}"
    mode: "0644"
    content: |
      deployed_at={{ ansible_date_time.iso8601 }}
      archive={{ kit_archive_path }}
      deploy_dir={{ deploy_dir }}
      host={{ inventory_hostname }}
