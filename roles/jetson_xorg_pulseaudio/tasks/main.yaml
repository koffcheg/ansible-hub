---
# 4.2.1. Disable GDM (as per doc)
- name: Disable and stop GDM (if present)
  become: true
  systemd:
    name: gdm
    enabled: false
    state: stopped
  ignore_errors: true   # Some Jetsons may not have gdm installed

# 4.2.2. Install Xorg-related files
- name: Install start-xorg.sh
  become: true
  copy:
    src: start-xorg.sh
    dest: /usr/local/bin/start-xorg.sh
    owner: root
    group: root
    mode: "0755"

- name: Install eco-x-clean helper
  become: true
  copy:
    src: eco-x-clean
    dest: /usr/local/sbin/eco-x-clean
    owner: root
    group: root
    mode: "0755"

- name: Install Xorg config
  become: true
  copy:
    src: xorg.conf
    dest: /etc/X11/xorg.conf
    owner: root
    group: root
    mode: "0644"

- name: Install xorg-pulseaudio service unit
  become: true
  copy:
    src: xorg-pulseaudio.service
    dest: /etc/systemd/system/xorg-pulseaudio.service
    owner: root
    group: root
    mode: "0644"

# 4.2.3. Pulseaudio configs
- name: Install asound.conf
  become: true
  copy:
    src: pulaudio/asound.conf
    dest: /etc/asound.conf
    owner: root
    group: root
    mode: "0644"

- name: Install default.pa
  become: true
  copy:
    src: pulaudio/default.pa
    dest: /etc/pulse/default.pa
    owner: root
    group: root
    mode: "0644"

# User-level systemd for pulseaudio
- name: Ensure user systemd config dir exists
  become: true
  file:
    path: /home/checkout/.config/systemd/user
    state: directory
    owner: checkout
    group: checkout
    mode: "0755"

- name: Install pulseaudio user service
  become: true
  copy:
    src: pulaudio/pulseaudio.service
    dest: /home/checkout/.config/systemd/user/pulseaudio.service
    owner: checkout
    group: checkout
    mode: "0644"

- name: Ensure pulseaudio override dir exists
  become: true
  file:
    path: /home/checkout/.config/systemd/user/pulseaudio.service.d
    state: directory
    owner: checkout
    group: checkout
    mode: "0755"

- name: Install pulseaudio override.conf
  become: true
  copy:
    src: pulaudio/pulseaudio.service.d/override.conf
    dest: /home/checkout/.config/systemd/user/pulseaudio.service.d/override.conf
    owner: checkout
    group: checkout
    mode: "0644"

- name: Install pulseaudio restart.conf
  become: true
  copy:
    src: pulaudio/pulseaudio.service.d/restart.conf
    dest: /home/checkout/.config/systemd/user/pulseaudio.service.d/restart.conf
    owner: checkout
    group: checkout
    mode: "0644"

- name: Install pulseaudio startup-delay.conf
  become: true
  copy:
    src: pulaudio/pulseaudio.service.d/startup-delay.conf
    dest: /home/checkout/.config/systemd/user/pulseaudio.service.d/startup-delay.conf
    owner: checkout
    group: checkout
    mode: "0644"

# 4.2.4. Enable and start services (Xorg + pulseaudio)
# Xorg-pulseaudio is a system service
- name: Reload systemd units for xorg-pulseaudio
  become: true
  systemd:
    daemon_reload: true
  when: not ansible_check_mode

- name: Enable and start xorg-pulseaudio systemd service
  become: true
  systemd:
    name: xorg-pulseaudio.service
    enabled: true
    state: started
  when: not ansible_check_mode

# Pulseaudio is a user service; we must run systemctl --user as checkout
- name: Get UID of checkout user (remote)
  become: true
  command: id -u checkout
  register: checkout_uid
  changed_when: false
  when: not ansible_check_mode

- name: Start pulseaudio user service for checkout
  become: true
  become_user: checkout
  environment:
    # Ensure systemd --user talks to correct runtime directory
    XDG_RUNTIME_DIR: "/run/user/{{ checkout_uid.stdout }}"
  command: systemctl --user enable --now pulseaudio.service
  when: not ansible_check_mode

- name: Ensure pulseaudio is active
  become: true
  become_user: checkout
  environment:
    XDG_RUNTIME_DIR: "/run/user/{{ lookup('ansible.builtin.pipe','id -u checkout') }}"
  command: systemctl --user restart pulseaudio.service
